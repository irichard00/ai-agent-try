# genie_tool/api/file_manage.py Code Documentation

## File Summary

This module provides REST API endpoints for file management operations including file upload, download, preview, and listing. It handles both content-based and multipart file uploads, manages file metadata in the database, and serves files with appropriate content types and headers. The module integrates with a database layer for file tracking and provides URL generation for file access.

## API Endpoints

### `POST /get_file`
- **Function**: `get_file(body: FileRequest)`
- **Purpose**: Retrieves file information and generates access URLs for a specific file
- **Parameters**: 
  - `body`: FileRequest containing request_id and file_name
- **Returns**: JSONResponse with file URLs and metadata
- **Logic**: 
  - Looks up file by file_id in database
  - Generates preview and download URLs
  - Returns file metadata including URLs and request information
  - Raises exception if file not found

### `POST /upload_file`
- **Function**: `upload_file(body: FileUploadRequest)`
- **Purpose**: Uploads file content directly via JSON request body
- **Parameters**: 
  - `body`: FileUploadRequest containing file content, name, description, and IDs
- **Returns**: JSONResponse with file URLs and size information
- **Logic**: 
  - Saves file content to database using FileInfoOp
  - Generates preview and download URLs
  - Returns file access information and size

### `POST /upload_file_data`
- **Function**: `upload_file_data(file: UploadFile, request_id: str)`
- **Purpose**: Handles multipart file upload with binary data
- **Parameters**: 
  - `file`: UploadFile object with file data
  - `request_id`: Form field for request identification
- **Returns**: JSONResponse with file URLs and size
- **Logic**: 
  - URL-decodes the filename
  - Generates file_id from request_id and filename
  - Saves file using FileInfoOp
  - Returns file access URLs and metadata

### `POST /get_file_list`
- **Function**: `get_file_list(body: FileListRequest)`
- **Purpose**: Retrieves list of files based on request_id or filter criteria
- **Parameters**: 
  - `body`: FileListRequest with optional filters and pagination
- **Returns**: JSONResponse with file list and total size
- **Logic**: 
  - Fetches files by request_id if no filters provided
  - Otherwise fetches files by specific file_ids from filters
  - Calculates total size of all files
  - Generates URLs for each file and returns structured response

### `GET /download/{file_id}/{file_name}`
- **Function**: `download_file(file_id: str, file_name: str)`
- **Purpose**: Serves file for download with appropriate headers
- **Parameters**: 
  - `file_id`: Identifier for the file (actually request_id in current implementation)
  - `file_name`: Name of the file to download
- **Returns**: FileResponse for download or 404 error
- **Logic**: 
  - Generates actual file_id from path parameters
  - Looks up file in database
  - Checks if file exists on filesystem
  - Returns FileResponse with download disposition

### `GET /preview/{file_id}/{file_name}`
- **Function**: `preview_file(file_id: str, file_name: str)`
- **Purpose**: Serves file for preview/display in browser with content type detection
- **Parameters**: 
  - `file_id`: Identifier for the file (actually request_id in current implementation)
  - `file_name`: Name of the file to preview
- **Returns**: FileResponse with appropriate content type or 404 error
- **Logic**: 
  - Generates actual file_id from path parameters
  - Looks up file in database and verifies existence
  - Determines content type based on file extension
  - Sets appropriate disposition (inline for previewable files, attachment for others)
  - Handles special case for markdown files
  - Returns FileResponse with CORS headers

## Key Components

### Dependencies
- **FastAPI**: Web framework components (APIRouter, File, Form, etc.)
- **FastAPI Responses**: JSONResponse, Response, FileResponse
- **mimetypes**: Content type detection
- **urllib.parse**: URL encoding/decoding utilities

### Database Integration
- Uses `FileInfoOp` for database operations
- Integrates with file table operations for metadata management
- Generates file URLs using utility functions

### URL Management
- `get_file_preview_url()`: Generates preview URLs
- `get_file_download_url()`: Generates download URLs
- Uses `get_file_id()` for consistent file identification

### File Handling Features
- Content-based uploads via JSON
- Multipart file uploads
- Content type detection and appropriate serving
- CORS support for cross-origin requests
- URL encoding for international filenames
- File existence verification

## Technical Notes

### File ID Management
- Comment indicates current implementation uses request_id as file_id parameter in URLs
- Actual file_id is generated by combining request_id and filename
- TODO comment suggests this should be unified in future

### Content Type Handling
- Special handling for markdown files (.md)
- Automatic content type detection using mimetypes
- Fallback to octet-stream for unknown types
- Inline disposition for previewable content, attachment for downloads

### Error Handling
- Returns 404 for missing files
- Validates file existence both in database and filesystem
- Proper exception handling with descriptive messages

### Security Considerations
- URL encoding to handle special characters
- File path validation
- Content type detection to prevent security issues
- CORS headers for controlled cross-origin access